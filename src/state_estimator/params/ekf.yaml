# src/state_estimator/params/ekf.yaml
### ekf.yaml ###
ekf_filter_node:
  ros__parameters:
    # ---------------------------------------------------------
    # 1. 기본 설정 (System Config)
    # ---------------------------------------------------------
    frequency: 30.0               # 필터 갱신 주기 (Hz)

    # 데이터 지연/끊김 방어 설정
    sensor_timeout: 0.5
    transform_timeout: 0.2

    two_d_mode: true              # 2D 로봇이므로 Z축, Roll, Pitch 무시
    publish_acceleration: false   # 가속도 정보 발행 여부
    publish_tf: true              # odom -> base_link TF 발행 (EKF가 메인 TF 담당)

    # ---------------------------------------------------------
    # 2. 좌표계 설정 (Frames)
    # ---------------------------------------------------------
    map_frame: map                # (SLAM 사용 시 필요, 지금은 미사용)
    odom_frame: odom              # 로컬 좌표계 기준 (Start Point)
    base_link_frame: base_link    # 로봇 본체
    world_frame: odom             # 로컬 위치 추정 모드 (map 사용 시 map으로 변경)

    # ---------------------------------------------------------
    # 3. 센서 입력 1: Wheel Odometry (odom_publisher)
    # ---------------------------------------------------------
    odom0: wheel/odom             # 우리가 리매핑한 토픽 이름
    
    # 설정 Matrix: [x, y, z, 
    #              roll, pitch, yaw, 
    #              vx, vy, vz, 
    #              vroll, vpitch, vyaw, 
    #              ax, ay, az]
    # 'true'인 값만 필터에 반영됩니다.
    
    # [전략]
    # - 위치(x,y,yaw): 바퀴는 미끄러짐으로 위치가 누적 오차를 가지므로 false (상대 속도만 신뢰)
    # - 속도(vx,vy,vyaw): 엔코더의 속도 계산은 매우 정확하므로 true
    odom0_config: [false, false, false,
                   false, false, false,
                   true,  true,  false,
                   false, false, false,
                   false, false, false]
                   
    odom0_queue_size: 10
    odom0_nodelay: false
    odom0_differential: false
    odom0_relative: false

    # ---------------------------------------------------------
    # 4. 센서 입력 2: IMU (자이로 센서)
    # ---------------------------------------------------------
    imu0: imu                     # 파서가 발행하는 토픽 이름
    
    # [전략]
    # - 각속도(vyaw): IMU의 핵심인 회전 속도(Z축 각속도)만 신뢰
    # - 가속도(ax,ay): 시뮬레이터가 이상적이므로 켜도 되지만, 
    #                 보통 초기에는 끄고 각속도만으로 회전을 잡는 것이 안정적임.
    imu0_config: [false, false, false,
                  false, false, false,
                  false, false, false,
                  false, false, true,
                  false, false, false]

    imu0_differential: false
    imu0_relative: true           # 첫 측정값을 0으로 기준 잡음 (드리프트 방지)
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: true # 중력 가속도 제거

    # ---------------------------------------------------------
    # 5. 프로세스 노이즈 (Process Noise Covariance)
    # ---------------------------------------------------------
    # 시스템 모델의 예측 불확실성.

    # 상태 벡터 순서 (15개):
    #  0: X (위치)       1: Y (위치)       2: Z (위치)
    #  3: Roll (자세)    4: Pitch (자세)   5: Yaw (자세)
    #  6: VX (선속도)    7: VY (선속도)    8: VZ (선속도)
    #  9: VRoll (각속도) 10: VPitch (각속도) 11: VYaw (각속도)
    # 12: AX (가속도)    13: AY (가속도)    14: AZ (가속도)
    
    # 대각선 성분(자신과의 공분산)만 설정하고 나머지는 0으로 둡니다.
    # 값이 클수록 시스템 예측을 불신하고 센서 값을 더 따릅니다.
    process_noise_covariance: [0.05, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.05, 0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.06, 0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.03, 0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.03, 0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.06, 0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.025, 0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.025, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.04, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.01, 0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.01, 0.0,    0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.02, 0.0,    0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.01, 0.0,    0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.01, 0.0,
                               0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.015]

    # ---------------------------------------------------------
    # 6. 초기 추정 공분산 (Initial Estimate Covariance)
    # ---------------------------------------------------------
    # 로봇의 첫 위치(0,0,0)에 대한 확신 정도.
    # 아주 작은 값(1e-9)은 "나 여기 있는 거 100% 확실해"라는 뜻.
    initial_estimate_covariance: [1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9]