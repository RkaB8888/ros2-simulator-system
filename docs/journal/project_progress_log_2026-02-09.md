## ğŸ› ï¸ Host Load Latency Fix & EKF Integration (2026-02-09)

**ëª©í‘œ**: Windows í˜¸ìŠ¤íŠ¸ ë¶€í•˜ ì‹œ ë°œìƒí•˜ëŠ” WSL2 í†µì‹  ì§€ì—°(Lag) ë¬¸ì œ í•´ê²° ë° EKF(í™•ì¥ ì¹¼ë§Œ í•„í„°)ë¥¼ í†µí•œ ìœ„ì¹˜ ì¶”ì • ì •ë°€ë„ í–¥ìƒ.

### 1. ë¬¸ì œ ë¶„ì„ ë° ì›ì¸ ê·œëª… (Troubleshooting)
- **í˜„ìƒ**: ê³ ì‚¬ì–‘ ì‹œë®¬ë ˆì´ì…˜(Unity) ì‹¤í–‰ ì‹œ, WSL2 ROS 2 ë…¸ë“œì—ì„œ ì•½ **0.5ì´ˆ ê°„ê²©ì˜ ë©ˆì¶¤(Lag)** í›„ **ë°ì´í„°ê°€ í•œêº¼ë²ˆì— ìŸì•„ì§€ëŠ”(Burst)** í˜„ìƒ ë°œìƒ.
- **ë²”ì¸ ì°¾ê¸° (êµì°¨ ê²€ì¦ ì‹¤í—˜)**:
  1. **Python ë¬¸ì œ?**: C++ë¡œ ì‹¹ ë‹¤ ë°”ê¿¨ëŠ”ë°ë„ ë˜‘ê°™ìŒ -> **X**
  2. **WSL2ê°€ ëŠë¦°ê°€?**: `tcpdump`ë¡œ ë³´ë‹ˆ ë ‰ ê±¸ë¦´ ë•Œ íŒ¨í‚· ìì²´ê°€ ì•ˆ ë“¤ì–´ì˜¤ê³  ìˆìŒ(Gap) -> **X**
  3. **ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ(Upstream) ë¬¸ì œ?** -> **O**
     - **Windows (Wireshark)**: 0.01ì´ˆë§ˆë‹¤ ì˜ ë³´ë‚´ê³  ìˆìŒ (ë³´ë‚´ëŠ” ìª½ì€ ì •ìƒ).
     - **WSL2 (Tcpdump)**: 0.5ì´ˆ ë™ì•ˆ ì•„ë¬´ê²ƒë„ ì•ˆ ì˜´.
- **ìµœì¢… ì›ì¸**: **Windows í˜¸ìŠ¤íŠ¸ ë¶€í•˜ë¡œ ì¸í•´ Hyper-V/WSL2 ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œì—ì„œ íŒ¨í‚· ì „ë‹¬ì´ ì§€ì—°(Stall/Buffering)ë¨.**
  - ì•± ë¬¸ì œê°€ ì•„ë‹ˆë¼ OS ê°€ìƒí™” êµ¬ì¡° ë¬¸ì œë¼ ì½”ë“œë¡œ ê·¼ë³¸ í•´ê²° ë¶ˆê°€

### 2. í•´ê²° ë°©ì•ˆ (Solution)
ê·¼ë³¸ í•´ê²°ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ, ë¡œë´‡(ROS) ì…ì¥ì—ì„œ ì´ìƒí•œ ë°ì´í„°ë¥¼ ê±¸ëŸ¬ë‚´ëŠ” **ë°©ì–´ ë¡œì§** ì ìš©.

1. **Odom ì ë¶„ ë°©ì–´ (Anti-Lag)**:
   - "0.1ì´ˆ ì´ìƒ ë°ì´í„°ê°€ ì•ˆ ì˜¤ë©´, ê·¸ ì‚¬ì´ëŠ” ë¬´ì‹œ"
   - ì§€ì—° í›„ ë„ì°©í•œ ë°ì´í„°ë¡œ ë¡œë´‡ì´ **ìˆœê°„ì´ë™(Teleport)í•˜ëŠ” ê²ƒì„ ë°©ì§€**.
2. **IMU ë²„ìŠ¤íŠ¸ ë°©ì–´ (Anti-Burst)**:
   - "0.002ì´ˆ ë¯¸ë§Œìœ¼ë¡œ ë°ì´í„°ê°€ ë§‰ ë“¤ì–´ì˜¤ë©´, ì´ê±´ ë°€ë ¸ë‹¤ê°€ ìŸì•„ì§€ëŠ” ê²ƒ"
   - ë²„í¼ë§ ë˜ì—ˆë‹¤ê°€ í•œêº¼ë²ˆì— ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ ë²„ë ¤ì„œ **EKFê°€ íŠ€ëŠ” ê²ƒì„ ë°©ì§€**.

### 3. ê¸°ëŠ¥ êµ¬í˜„ (EKF Integration)
- **Robot Localization íŒ¨í‚¤ì§€ ë„ì…**:
  - ê¸°ì¡´: `Odom Publisher` í˜¼ìì„œ ìœ„ì¹˜ ì¶”ì •í•˜ê³  TFë„ ì¨.
  - ë³€ê²½: `Odom Publisher`ëŠ” ì¬ë£Œ(ì†ë„)ë§Œ ì£¼ê³ , ìš”ë¦¬(ìœ„ì¹˜ ì¶”ì •/TF)ëŠ” **EKF ë…¸ë“œ**ê°€ ì „ë‹´.
- **ë°ì´í„° íë¦„ ë³€ê²½**:
  - `state_estimator` ì¶œë ¥: `odom` â†’ `wheel/odom` (ë¦¬ë§¤í•‘)
  - ìµœì¢… ì¶œë ¥: `wheel/odom` + `imu` â†’ **EKF** â†’ `odom`
- **ê³µë¶„ì‚°(Covariance) íŠœë‹**:
  - EKFê°€ ë°ì´í„°ë¥¼ ì–¼ë§ˆë‚˜ ë¯¿ì„ì§€ ê²°ì •í•˜ëŠ” ê°’ ì„¤ì •.
  - `odom_publisher`: ì†ë„ ê³µë¶„ì‚° ì¶”ê°€ (Linear: 0.02, Angular: 0.04).
  - `imu_parser`: ì£¼ìš” ì¸¡ì •ê°’(ê°ì†ë„ ë“±)ì˜ ê³µë¶„ì‚°ì„ 0.05ë¡œ ì„¤ì • (ê¸°ì¡´ì—” -1ë¡œ ëª¨ë¦„ ìƒíƒœì˜€ìŒ).

### 4. ì£¼ìš” ì½”ë“œ ë³€ê²½ ì‚¬í•­

#### A. Odom Publisher (ì§€ì—° ë°©ì–´)
```cpp
// src/state_estimator/src/odom_publisher.cpp
void integrate(const Sample &s) {
    double dt = (s.stamp - last_state_stamp_).seconds();
    
    // [Fix] 0.1ì´ˆ ì´ìƒ ì§€ì—°ëœ íŒ¨í‚·ì€ Hyper-V ë ‰ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì ë¶„ ìƒëµ
    if (dt > 0.1) {
        RCLCPP_WARN(get_logger(), "Lag (dt=%.3f s). Skipping integration.", dt);
        last_state_stamp_ = s.stamp;
        return;
    }
    // ... ì ë¶„ ë¡œì§ ...
}
```

#### B. IMU Parser (ë²„ìŠ¤íŠ¸ ë°©ì–´)
```cpp
// src/udp_parsers_cpp/src/imu_parser.cpp
double diff = (current_time - last_publish_time_).seconds();

// [Fix] 2ms ë¯¸ë§Œ ê°„ê²© íŒ¨í‚·ì€ ë°€ë ¸ë‹¤ ë“¤ì–´ì˜¨ ë²„ìŠ¤íŠ¸ ë°ì´í„°ì´ë¯€ë¡œ ë“œë
if (diff < 0.002) {
    RCLCPP_WARN_THROTTLE(..., "IMU Burst detected! Dropping packet...");
    return;
}
```

#### C. Launch File (EKF êµ¬ì„±)
```python
# src/state_estimator/launch/odom.launch.py
Node(
    package='robot_localization',
    executable='ekf_node',
    # ...
    parameters=[ekf_params_file],
    remappings=[('odometry/filtered', 'odom')] # ìµœì¢… ì¶œë ¥
)
```